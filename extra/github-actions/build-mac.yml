# Zlib, Mbedtls and PCRE2 are built from source and statically linked
# to ensure compatibility with the chosen deployment target
# Deployment target and library versions are defined by env vars in main.yml

- name: Cache native dependencies
  id: cache-native-deps
  uses: actions/cache@v4
  with:
    path: |
      zlib-${{ env.ZLIB_VERSION }}
      mbedtls-${{ env.MBEDTLS_VERSION }}
      pcre2-${{ env.PCRE2_VERSION }}
    key: ${{ matrix.os }}-${{ env.ZLIB_VERSION }}-${{ env.MBEDTLS_VERSION }}-${{ env.PCRE2_VERSION }}

- name: Install Homebrew & CPAN dependencies
  run: |
    set -ex
    brew update
    brew bundle --file=tests/Brewfile --no-upgrade
    cpanm IPC::System::Simple
    cpanm String::ShellQuote

- name: Build native dependencies
  if: steps.cache-deps.outputs.cache-hit != 'true'
  run: |
    curl -L https://github.com/madler/zlib/releases/download/v$ZLIB_VERSION/zlib-$ZLIB_VERSION.tar.gz | tar xz
    cd zlib-$ZLIB_VERSION
    ./configure
    sudo make -j`sysctl -n hw.ncpu`
    cd ..
    curl -L https://github.com/ARMmbed/mbedtls/archive/v$MBEDTLS_VERSION.tar.gz | tar xz
    cd mbedtls-$MBEDTLS_VERSION
    sudo make -j`sysctl -n hw.ncpu`
    cd ..
    curl -L https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2_VERSION/pcre2-$PCRE2_VERSION.tar.gz | tar xz
    cd pcre2-$PCRE2_VERSION
    ./configure --enable-unicode --enable-pcre2-8 --enable-pcre2-16 --enable-pcre2-32 --enable-unicode-properties --enable-pcre2grep-libz --enable-pcre2grep-libbz2 --enable-jit
    sudo make -j`sysctl -n hw.ncpu`
    cd ..

- name: Install native dependencies
  run: |
   sudo make -C zlib-$ZLIB_VERSION install
   sudo make -C mbedtls-$MBEDTLS_VERSION install
   sudo make -C pcre2-$PCRE2_VERSION install

- name: Install OCaml libraries
  if: steps.cache-opam.outputs.cache-hit != 'true'
  run: |
    set -ex
    opam init -c ${{env.OCAML_VERSION}}
    eval $(opam env)
    opam update
    opam env
    opam install . --deps-only --assume-depexts
    opam list
    ocamlopt -v

- name: Set ADD_REVISION=1 for non-release
  if: ${{ !startsWith(github.ref, 'refs/tags/') }}
  run: echo "ADD_REVISION=1" >> $GITHUB_ENV

- name: Build Haxe
  run: |
    set -ex
    eval $(opam env)
    make -s STATICLINK=1 haxe
    make -s haxelib
    make -s package_unix package_installer_mac
    ls -l out
    otool -L ./haxe
    otool -L ./haxelib

- name: Upload artifact (x64)
  if: runner.arch == 'X64'
  uses: actions/upload-artifact@v4
  with:
    name: macX64Binaries
    path: out

- name: Upload artifact (arm)
  if: runner.arch == 'ARM64'
  uses: actions/upload-artifact@v4
  with:
    name: macArmBinaries
    path: out
